<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <meta name="description"
              content="Home page for Milburn Parish Counci : About, Minutes, Agendas, Policies, Financial Statements, Sundry">
        <title>Home - Milburn Parish Council</title>
        <meta name="keywords"
              content="About, minutes, agendas, policies, financial statements, sundry">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Bootstrap includes from https://www.w3schools.com/bootstrap4/tryit.asp?filename=trybs_carousel2 -->

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <!-- sortableJS styles -->
        <link rel="stylesheet" type="text/css" href="st/theme.css">
        <!-- code for datepicker -->
        <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

        <style>
            div.ui-datepicker {
                font-size:12px;
                background: gainsboro;
                border: 1px solid #555;
                color: blue;
            }

            /* current input value background color */
            .ui-datepicker-current-day
            {
                background: #83C948
            }
            /* today's background color */
            .ui-datepicker-today
            {
                background: #83C948
            }

            #ui-datepicker-div {z-index:9999 !important}

            .launchpadlink {
                width: 5.5em;
                padding: .5em;
                color: blue;
                border: 1px solid black;
                border-radius: .5em;
                padding: .5em;
                display: inline-block;
                text-decoration: none !important;
                margin: 1em auto 1em auto;
            }

            .view {
                background-color: LAVENDER;
            }

            .amend {
                background-color: MEDIUMAQUAMARINE;
            }

            .configure {
                background-color: WHEAT;
            }

            label {
                font-weight: bold;
            }
        </style>

    </head>
    <body>

        <form id = 'dummyform'> <!-- dummy form used to communicate with php helper functions -->
        </form>

        <!--  ++++++++++++  Header ++++++++++++++++++++++++++ -->

        <div style = 'margin: 2vh auto 2vh auto; width: 75%; text-align: center;'>
            <div style ='padding: 2vh; background: white;'>
                <h2 style = "width: 70%; margin: 1vh auto auto auto; padding-top: 1vh; padding-bottom: 1vh; background: Aquamarine;">Parish Council Website Management Screen</h2>

                <!--  ++++++++++++  Controls ++++++++++++++++++++++++++ -->

                <table style="width: 70%; margin: 2vh auto 2vh auto; border: 1px solid black; padding: 1.5vh; border-collapse: separate; background: white;">
                    <tr>
                        <td><p id = "entriesbutton" class="launchpadlink" style = "width: 12em;" title="Add/remove/edit Entries for Sections">
                                <a onclick = "displayEntriesUpdateView('anchor', '');">Manage Entries<br>
                                </a>
                                <span id ="entriesbuttonpicklist"></span>
                            </p>
                        </td>
                        <td>
                            <a id = "carouselbutton" class="launchpadlink" title="Add/remove/reorder/edit Slides within the Carousel"
                               onclick = "anchorTarget = 'carousel'; displayCarouselUpdateView('');">Configure<br>Carousel</a>
                        </td>
                        <td>
                            <a id = "sectionsbutton" class="launchpadlink" title="Add/remove/reorder/edit Sections"
                               onclick = "anchorTarget = 'sections'; displaySectionsUpdateView('');">Configure<br>Sections</a>
                        </td>
                        <td>
                            <a id = "viewbutton" class="launchpadlink" title="Launch the website in a popup"
                               onclick ="popUpWindow = window.open('index.html', 'PC website popup',
                                               width = ' + (parseInt(window.innerWidth) * 0.9) + ', height = ' + (parseInt(window.innerHeight) * 0.9) + ', left = ' + (parseInt(window.innerWidth) * 0.05) + ', top = ' + (parseInt(window.innerHeight) * 0.1) + ', resizable = 'yes');">
                                Launch<br>Website</a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!--  ++++++++++++  Code for Active Control   ++++++++++++++++++++++++++ -->

        <div id = 'currentcontrol'>
        </div>

        <!--  ++++++++++++  Support popups   ++++++++++++++++++++++++++ -->

        <script>

            function applyDatepicker(elementId) {

                var oldDate = document.getElementById(elementId).placeholder;
                $('#' + elementId).datepicker();
                $('#' + elementId).datepicker('option', 'dateFormat', 'yy-mm-dd');
                $('#' + elementId).datepicker('option', 'changeMonth', true);
                $('#' + elementId).datepicker('option', 'changeYear', true);
                $('#' + elementId).datepicker('option', 'yearRange', '1999:c');
                $('#' + elementId).datepicker()
                        .on('input change', function (e) {
                            var newDate = document.getElementById(elementId).value;
                        });
            }

            function launchUpdateView() {

                // Build the picklist and then display the current anchorTarget Update View

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_section_picklist");
                currentSectionId = '';
                if (localStorage.getItem('pcouncillastsectionid')) {
                    currentSectionId = localStorage.getItem('pcouncillastsectionid');
                }
                oData.append("current_section_id", currentSectionId);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('entriesbuttonpicklist').innerHTML = response;
                            // if the system has just initialised itself, point the update display
                            // at sections', otherwise default to tbe last section used in 'entries'

                            var selectedSectionId = sectionspicklist.options[sectionspicklist.selectedIndex].value;
                            if (selectedSectionId == "default") {
                                // initialise 'pcouncillastsectionid'
                                localStorage.setItem('pcouncillastsectionid', 'default');
                                displaySectionsUpdateView(" ")

                            } else {

                                if (anchorTarget == "sections") {
                                    displaySectionsUpdateView('');
                                } else {

                                    // display updateview for the last section used - note that if the system
                                    // has not yet been initialised then currentSectionId will still be ''
                                    displayEntriesUpdateView('anchor', '');
                                }
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            var currentSectionId;
            var currentSectionType;
            function displayEntriesUpdateView(entryPoint, message) {

                // entryPoint tells you if you've entered for the Anchor button ("anchor")
                // or from the options select element ("select")

                if (entryPoint == "anchor") {

                    // we've not been explicitly given a section target so need to decide
                    // what to do. First see if there's a value in local storage

                    if (localStorage.getItem('pcouncillastsectionid')) {
                        currentSectionId = localStorage.getItem('pcouncillastsectionid');
                    } else {
                        var sectionspicklist = document.getElementById('sectionspicklist')
                        currentSectionId = sectionspicklist.options[sectionspicklist.selectedIndex].value;
                    }
                } else {
                    var sectionspicklist = document.getElementById('sectionspicklist')
                    currentSectionId = sectionspicklist.options[sectionspicklist.selectedIndex].value;
                }

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_entries_update_table");
                oData.append("section_id", currentSectionId);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            displaySuccessMessage(message);
                            localStorage.setItem('pcouncillastsectionid', currentSectionId);
                            // the sectionType for currentSectionId is tucked away in a hidden span in the html you've
                            // just placed in currentcontrol

                            currentSectionType = document.getElementById('currentsectiontype').innerHTML
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertEntry() {

                if (currentSectionType == "date_title") {
                    var entryDate = document.getElementById("entrydate").value;
                    var entrySuffix = document.getElementById("entrysuffix").value;
                } else {
                    var entryTitle = document.getElementById("entrytitle").value;
                }

                var entryFilename = document.getElementById("entryfilename").value;
                if (!validEntry(currentSectionType, entryDate, entrySuffix, entryTitle, entryFilename))
                    return;
                var form = document.forms.namedItem('entryform');
                var oData = new FormData(form);
                oData.append("helper_type", "insert_entry");
                oData.append("section_id", currentSectionId);
                oData.append("section_type", currentSectionType);
                if (currentSectionType == "date_title") {
                    oData.append("entry_date", document.getElementById("entrydate").value);
                    oData.append("entry_suffix", document.getElementById("entrysuffix").value);
                } else {
                    oData.append("entry_title", document.getElementById("entrytitle").value);
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayEntriesUpdateView('anchor', "Insert succeeded");
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateEntry(entryIndex) {

                var entryDate = '';
                var entrySuffix = '';
                var entryTitle = '';
                var currentEntryFilename = document.getElementById('currententryfilename' + entryIndex).innerHTML;
                var entryFilename = currentSectionId;
                if (currentSectionType == "date_title") {
                    entryDate = document.getElementById("entrydate" + entryIndex).value;
                    entrySuffix = document.getElementById("entrysuffix" + entryIndex).value;
                    entryFilename += "_" + entryDate;
                    if (entrySuffix != '') {
                        entryFilename += "_" + entrySuffix;
                    }
                } else {
                    entryTitle = document.getElementById("entrytitle" + entryIndex).value;
                    entryFilename += "_" + entryTitle;
                }
                entryFilename += ".pdf";
                if (!validEntry(currentSectionType, entryDate, entrySuffix, entryTitle, entryFilename))
                    return;
                var form = document.forms.namedItem("entryform" + entryIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "update_entry");
                oData.append("entry_index", entryIndex);
                oData.append("section_id", currentSectionId);
                oData.append("section_type", currentSectionType);
                oData.append("current_filename", currentEntryFilename);
                if (currentSectionType == "date_title") {
                    oData.append("entry_date", document.getElementById("entrydate" + entryIndex).value);
                    oData.append("entry_suffix", document.getElementById("entrysuffix" + entryIndex).value);
                } else {
                    oData.append("entry_title", document.getElementById("entrytitle" + entryIndex).value);
                }
                var sourceStatus = "source file not provided";
                if (document.getElementById("entryfilename" + entryIndex).value != '')
                    sourceStatus = "new source file provided";
                oData.append("source_status", sourceStatus);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayEntriesUpdateView('anchor', "Update succeded");
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function validEntry(sectionType, entryDate, entrySuffix, entryTitle, entryFilename) {

                if (sectionType == "date_title") {

                    if (entryDate == '') {
                        displayFailureMessage("Oops - you need to specify an entry date");
                        return false;
                    }

                    var illegalCharacter = checkForImpermissibleCharacter(entrySuffix);
                    if (illegalCharacter != '') {
                        displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in Suffix");
                        return false;
                    }

                } else {

                    if (entryTitle == '') {
                        displayFailureMessage("Oops - you need to specify an entry title");
                        return false;
                    }

                    illegalCharacter = checkForImpermissibleCharacter(entryTitle);
                    if (illegalCharacter != '') {
                        displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in Title");
                        return false;
                    }
                }

                if (entryFilename == '') {
                    displayFailureMessage("Oops - you need to specify a filename");
                    return false;
                }
                return true;
            }

            function checkForImpermissibleCharacter(characterString) {

                // check that characterString doesnt contain an _ character or anything that would
                // be impermissible in a windows or unix filename

                var illegalChar = '';
                if (characterString.includes('_'))
                    illegalChar = '_';
                if (characterString.includes('£'))
                    illegalChar = '£';
                if (characterString.includes('%'))
                    illegalChar = '%';
                if (characterString.includes('&'))
                    illegalChar = '&';
                if (characterString.includes('{'))
                    illegalChar = '{';
                if (characterString.includes('}'))
                    illegalChar = '}';
                if (characterString.includes('<'))
                    illegalChar = '<';
                if (characterString.includes('>'))
                    illegalChar = '>';
                if (characterString.includes('*'))
                    illegalChar = '*';
                if (characterString.includes('"'))
                    illegalChar = '"';
                if (characterString.includes("'"))
                    illegalChar = "'";
                if (characterString.includes('+'))
                    illegalChar = '+';
                if (characterString.includes('|'))
                    illegalChar = '!';
                if (characterString.includes('='))
                    illegalChar = '=';
                return illegalChar;
            }

            function deleteEntry(filename) {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "delete_entry");
                oData.append("filename", filename);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayEntriesUpdateView('anchor', "Delete succeded");
                        }
                    }
                };
                oReq.send(oData);
            }

            function displayCarouselUpdateView(message) {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_carousel_update_table");
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            displaySuccessMessage(message);
                            new Sortable(slidessortablelist, {
                                animation: 150,
                                ghostClass: 'sortable-ghost'
                            });
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateWebsiteTitle() {

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "update_website_title");
                oData.append("website_title", document.getElementById('websitetitle').value);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayCarouselUpdateView('Update succeeded');
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertSlide() {

                // Note that to get the $_FILES Post data across to helpers we have to use a
                // real form (ie one deeclared as type POST etc)

                var slideTitle = document.getElementById("slidetitle").value

                var illegalCharacter = checkForImpermissibleCharacter(slideTitle);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in slide title");
                    return false;
                }

                if (slideTitle == '') {
                    displayFailureMessage("Oops - you need to specify a title");
                    return false;
                }

                var slideFilename = document.getElementById("slidefilename").value

                if (slideFilename == '') {
                    displayFailureMessage("Oops - you need to specify a filename");
                    return false;
                }

                var form = document.forms.namedItem('slideform');
                var oData = new FormData(form);
                oData.append("helper_type", "insert_slide");
                oData.append("slide_title", slideTitle);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView('Insert succeeded');
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function updateSlide(slideIndex) {

                var slideTitle = document.getElementById("slidetitle" + slideIndex).value

                var illegalCharacter = checkForImpermissibleCharacter(slideTitle);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in slide title");
                    return false;
                }

                if (slideTitle == '') {
                    displayFailureMessage("Oops - slide title cannot be blank");
                    return false;
                }

                var form = document.forms.namedItem("slideform" + slideIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "update_slide");
                oData.append("slide_index", slideIndex);
                oData.append("slide_title", slideTitle);
                var sourceStatus = "source file not provided";
                if (document.getElementById("slidefilename" + slideIndex).value != '')
                    sourceStatus = "new source file provided";
                oData.append("source_status", sourceStatus);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView("Update succeeded");
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function deleteSlide(slideIndex) {

                var slideTitle = document.getElementById('slidetitle' + slideIndex).value;
                message = "Do you really want to delete the slide for '";
                message += slideTitle + "'";
                if (!confirm(message))
                    return;
                var form = document.forms.namedItem("slideform" + slideIndex);
                var oData = new FormData(form);
                oData.append("helper_type", "delete_slide");
                oData.append("slide_index", slideIndex);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                displayCarouselUpdateView("Delete suucceeded");
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function reorderSlides() {

                var slides = document.getElementsByClassName('slideentry');
                var slidesPrecursorJson = "[";
                for (var i = 0; i < slides.length; i++) {

                    var j = slides[i].innerHTML;
                    slidesPrecursorJson += '{';
                    slidesPrecursorJson += '"slide_title" : "' + document.getElementById('slidetitle' + j).value + '"},';
                }
                slidesPrecursorJson = slidesPrecursorJson.substring(0, slidesPrecursorJson.length - 1);
                slidesPrecursorJson += "]";
                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "reorder_slides");
                oData.append("slides_precursor_json", slidesPrecursorJson);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displayCarouselUpdateView("Reorder succeeded");
                        }
                    }
                }
                ;
                oReq.send(oData);
            }

            function displaySectionsUpdateView(message) {

                // the message parameter is supplied by the calling routine to
                // to signal successful outcome of whatever operation preceded
                // the function call

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "build_sections_update_table");
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            document.getElementById('currentcontrol').innerHTML = response;
                            displaySuccessMessage(message);
                            new Sortable(sectionssortablelist, {
                                animation: 150,
                                ghostClass: 'sortable-ghost'
                            });
                        }
                    }
                };
                oReq.send(oData);
            }

            function insertSection() {

                var sectionId = document.getElementById('sectionid').value
                var illegalCharacter = checkForImpermissibleCharacter(sectionId);
                if (illegalCharacter != '') {
                    displayFailureMessage("Oops - character " + illegalCharacter + " is not allowed in ssection id");
                    return false;
                }

                var sectionId = document.getElementById('sectionid').value;
                if (sectionId == '') {
                    displayFailureMessage("Oops - you need to supply an id tag for the section");
                    return false;
                }

                var sectionHeader = document.getElementById('sectionheader').value;
                if (sectionHeader == '') {
                    displayFailureMessage("Oops - you need to supply a header for the section");
                    return false;
                }

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "insert_section");
                oData.append("section_id", sectionId);
                oData.append("section_header", document.getElementById('sectionheader').value);
                oData.append("section_prefix", document.getElementById('sectionprefix').value);
                if (document.getElementById('sectiontypedate').checked) {
                    oData.append("section_type", "date_title");
                } else {
                    oData.append("section_type", "standard_title");
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                // need to rebuild the pickist, so run launchUpdateView
                                launchUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            var saveTypeChanged = false;
            function updateSection(sectionIndex) {

                // the code below is very unsatisfactory but attempts using confirm or popup messages
                // to display the warning message when the radio button was clicked failed unpredictably -
                // It seemed (in Chrome at least) that the "toggling" action of the radio buttons was
                // "eaten" by the function call - but not every time! Mysteriously, only the radio buttons
                // on the first section displayed seemed to be affected

                message = "Changing the type of this Section will have an effect on the titles ";
                message += "of any Entries in the section. Changing the type for a standard_title ";
                message += "section will cause titles for entries for the section ";
                message += "to be replaced by dummy dates. Changing ";
                message += "the type for a date_title section will cause the date elements of the titles ";
                message += "for its entries to be replaced by a counter. ";

                if (saveTypeChanged) {
                    if (!confirm(message)) {
                        displaySectionsUpdateView(" ");
                        return;
                    }
                    saveTypeChanged = false;
                }

                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                // SectionId may be about to change - note the current and (potentially) new values
                var currentSectionId = document.getElementById('sectionid' + sectionIndex).placeholder;
                var newSectionId = document.getElementById('sectionid' + sectionIndex).value;

                oData.append("helper_type", "update_section");
                oData.append("section_index", sectionIndex);
                oData.append("section_id_old", currentSectionId);
                oData.append("section_id_new", newSectionId);
                oData.append("section_header", document.getElementById('sectionheader' + sectionIndex).value);
                oData.append("section_prefix", document.getElementById('sectionprefix' + sectionIndex).value);
                if (document.getElementById('sectiontypedate' + sectionIndex).checked) {
                    oData.append("section_type", 'date_title');
                } else {
                    oData.append("section_type", 'standard_title');
                }

                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                // if we've just renamed the section update the picklist
                                if (currentSectionId != newSectionId) {
                                    // if the local storage item is pointing to the current section, reest this, too
                                    if (localStorage.getItem('pcouncillastsectionid') == currentSectionId) {
                                        localStorage.setItem('pcouncillastsectionid', newSectionId);
                                    }
                                    launchUpdateView();
                                } else {
                                    displaySectionsUpdateView("Update succeedeed");
                                }
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            var sectionIdofDeletionTarget;
            function deleteSection(sectionIndex) {

                message = "Do you really want to delete section " + sectionIdofDeletionTarget + ". ";
                message += "Entry files will also be deleted. ";
                if (!confirm(message))
                    return;
                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "delete_section");
                oData.append("section_index", sectionIndex);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            if (response.indexOf("Oops") != -1) {
                                displayFailureMessage(response);
                            } else {
                                // if we've just deleted the current section, unset local storage. In
                                // any case, use launchUpdateView to rebuild picklist
                                if (localStorage.getItem('pcouncillastsectionid') == sectionIdofDeletionTarget) {
                                    window.localStorage.removeItem('pcouncillastsectionid');
                                }
                                launchUpdateView();
                            }
                        }
                    }
                };
                oReq.send(oData);
            }

            function reorderSections() {

                var sections = document.getElementsByClassName('sectionentry');
                var sectionsPrecursorJson = "[";
                for (var i = 0; i < sections.length; i++) {

                    var j = sections[i].innerHTML;
                    sectionsPrecursorJson += '{';
                    sectionsPrecursorJson += '"section_id" : "' + document.getElementById('sectionid' + j).value + '",';
                    sectionsPrecursorJson += '"section_header" : "' + document.getElementById('sectionheader' + j).value + '",';
                    sectionsPrecursorJson += '"section_prefix" : "' + document.getElementById('sectionprefix' + j).value + '",';
                    if (document.getElementById('sectiontypedate' + j).checked) {
                        sectionsPrecursorJson += '"section_type" : "date_title"},';
                    } else {
                        sectionsPrecursorJson += '"section_type" : "standard_title"},';
                    }
                }
                sectionsPrecursorJson = sectionsPrecursorJson.substring(0, sectionsPrecursorJson.length - 1);
                sectionsPrecursorJson += "]";
                var form = document.forms.namedItem("dummyform");
                var oData = new FormData(form);
                oData.append("helper_type", "reorder_sections");
                oData.append("sections_precursor_json", sectionsPrecursorJson);
                var oReq = new XMLHttpRequest();
                oReq.open("POST", "php/manager_helpers.php", true);
                oReq.onload = function (oEvent) {
                    if (oReq.status == 200) {

                        var response = oReq.responseText;
                        if (response.indexOf("%timed_out%") != -1) {
                            handleTimeout();
                            return;
                        }
                        var response = oReq.responseText;
                        if (response.indexOf("%failed%") != -1) {
                            alert(response);
                        } else {
                            displaySectionsUpdateView("Reorder succeded");
                        }
                    }
                }
                ;
                oReq.send(oData);
            }

            var anchorTarget;
            function clearMessageArea() {

                document.getElementById('messagearea').innerHTML = '';
            }

            function displaySuccessMessage(messageContent) {

                document.getElementById('messagearea').innerHTML = messageContent;
                document.getElementById('messagearea').style.color = 'blue';
            }

            function displayFailureMessage(messageContent) {

                document.getElementById('messagearea').innerHTML = messageContent;
                document.getElementById('messagearea').style.color = 'red';
            }

            function openFile(filename) {

                // Chrome won't let us connect to local resources so to provide a stopgap for testing
                // we link to server resources. All that's different between local and live running is
                // the form of the hreflink Add a "time" parameter to force reload

                dateObject = new Date();
                currentTime = dateObject.getTime();
                var hreflink = 'entries/' + filename + "?" + currentTime;
                // open links in new window unless this already exists, in which case overwrite

                window.open(hreflink, "milburnpc")
            }

            function handleTimeout() {

                // An attempt to execute a helper_function has returned a %timed-out% response. This
                // might be a genuine timeout of the php session record or could be a hacking attempt.
                // EIth way invite the user to login

                window.location.assign("login.html");
            }

            window.onload = function () {
                launchUpdateView();
            }

        </script>

        <!-- Latest Sortable -->
        <script src="sortable.js"></script>

    </body>
</html>
